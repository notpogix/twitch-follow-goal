<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Followers Goal Overlay</title>
  <style>
    :root {
      --text-shadow: 2px 2px 8px rgba(0,0,0,0.25);
    }
    body {
      margin: 0;
      padding: 0;
      background: transparent !important;
      overflow: hidden;
      font-family: 'Inter', Arial, sans-serif;
    }
    #follower-goal {
      color: #fff;
      text-shadow: var(--text-shadow);
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      white-space: nowrap;
      background: none !important;
      border: none;
      user-select: none;
      text-align: left;
      padding: 8px 12px;
      /* Let user scale font in OBS */
    }
  </style>
</head>
<body>
  <div id="follower-goal">Followers: ...</div>
  <script>
    /* === USER: EDIT THIS LINE TO CHANGE CHANNEL === */
    const TWITCH_CHANNEL = "marlon"; // <-- Replace with streamer's Twitch username

    /* == Overlay Logic == */
    let followerGoal = 200; // Default goal, can be changed with !setgoal in chat
    let currentFollowers = 0;
    let lastAnnouncedGoal = followerGoal;

    const goalKey = `tg_${TWITCH_CHANNEL}_goal`;

    // Restore latest goal from localStorage for session reloads (browser-side cache, OK for overlays)
    if (window.localStorage && window.localStorage.getItem(goalKey)) {
      followerGoal = +window.localStorage.getItem(goalKey) || followerGoal;
    }

    function updateDisplay() {
      document.getElementById('follower-goal').textContent =
        `Followers: ${currentFollowers}/${followerGoal}`;
    }

    async function fetchFollowers() {
      // Uses https://twitchstats.p.rapidapi.com endpoint for followers -- Public Twitch API doesn't provide follower count directly without auth
      // This overlay will use the Twitch Helix public API, but will fall back to a public endpoint as needed.
      // For best use, replace with an API endpoint or your own proxy if hitting limits.
      const user = TWITCH_CHANNEL.toLowerCase();
      try {
        // Step 1: Get User ID
        const userData = await fetch(`https://decapi.me/twitch/userid/${user}`);
        const userId = await userData.text();
        // Step 2: Use DecAPI to get follow count
        const res = await fetch(`https://decapi.me/twitch/followers/${user}`);
        const count = await res.text();
        currentFollowers = parseInt(count.replace(/\D/g, ''), 10);
        updateDisplay();
      } catch (e) {
        // fallback: show error
        document.getElementById('follower-goal').textContent = "Followers: (error)";
      }
    }

    // --- TWITCH CHAT LISTENER ---

    // Load tmi.js from CDN for Twitch chat commands
    (function loadTmiJs(cb) {
      const script = document.createElement('script');
      script.src = "https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js";
      script.onload = cb;
      document.head.appendChild(script);
    })(setupChat);

    function setupChat() {
      const client = new window.tmi.Client({
        channels: [TWITCH_CHANNEL]
      });

      client.connect().catch(() => {});

      client.on('message', (channel, tags, message, self) => {
        // Only allow streamer or mods to set goal
        if (self) return;
        const lower = message.trim().toLowerCase();
        if (lower.startsWith('!setgoal')) {
          // Mods or broadcaster only
          if (tags.mod || tags.badges && tags.badges.broadcaster) {
            const match = message.match(/!setgoal\s+(\d+)/i);
            if (match) {
              followerGoal = parseInt(match[1], 10);
              lastAnnouncedGoal = followerGoal;
              if (window.localStorage) {
                window.localStorage.setItem(goalKey, followerGoal + "");
              }
              updateDisplay();
            }
          }
        }
      });
    }

    // Update overlay every minute
    setInterval(fetchFollowers, 60000);
    fetchFollowers();
    updateDisplay();
  </script>
</body>
</html>
